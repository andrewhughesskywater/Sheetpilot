<?xml version="1.0" encoding="UTF-8"?>
<application>
  <metadata>
    <name>SheetPilot</name>
    <description>Electron-based timesheet automation application that enables users to create, manage, and submit timesheet entries to web forms via browser automation</description>
    <architecture>Electron (main + renderer) with React frontend and Node.js backend</architecture>
    <version>1.0.0</version>
  </metadata>

  <!-- ==================== BACKEND LAYER ==================== -->
  <layer name="backend" type="electron-main" description="Electron main process - handles system operations, database, IPC, and business logic">
    <keywords>backend, Electron main process, Node.js, IPC handlers, database, services, business logic, automation, SQLite, Playwright, bot</keywords>
    
    <!-- Entry Points -->
    <module name="entry-points" description="Application initialization and bootstrap">
      <keywords>entry points, main.ts, preload.ts, app initialization, IPC bridge, contextBridge</keywords>
      <file path="app/backend/src/main.ts">
        <purpose>Primary entry point for Electron main process. Manages application lifecycle, window creation, IPC handlers, auto-updates, and database initialization</purpose>
        <search-keywords>main process, entry point, Electron, app lifecycle, BrowserWindow, IPC handlers, registerIPCHandlers, auto-updater, database bootstrap, window state, isSubmissionInProgress</search-keywords>
        <responsibilities>
          <item>Initialize Electron application and configure app settings</item>
          <item>Create and manage BrowserWindow instances (main window and splash screen)</item>
          <item>Register all IPC handlers for frontend-backend communication</item>
          <item>Bootstrap database with proper schema</item>
          <item>Configure and manage auto-updater for application updates</item>
          <item>Handle window state persistence (size, position, maximized)</item>
          <item>Manage global error handlers for unhandled rejections</item>
          <item>Control submission concurrency with global flag</item>
        </responsibilities>
        <key-exports>
          <export name="registerIPCHandlers">Registers all IPC communication handlers</export>
        </key-exports>
        <dependencies>
          <import>electron (app, BrowserWindow, ipcMain, screen)</import>
          <import>./services/database - Database operations</import>
          <import>./services/timesheet-importer - Timesheet submission logic</import>
          <import>../../shared/errors - Error handling classes</import>
          <import>../../shared/logger - Logging system</import>
          <import>./middleware/bootstrap-plugins - Plugin system initialization</import>
        </dependencies>
        <data-flow>
          <input>User interactions from renderer via IPC</input>
          <input>Auto-update events from electron-updater</input>
          <input>Window events (resize, move, close)</input>
          <output>IPC responses to renderer process</output>
          <output>Database write operations</output>
          <output>Window state persistence to file system</output>
        </data-flow>
      </file>

      <file path="app/backend/src/preload.ts">
        <purpose>Security bridge between Electron main and renderer processes. Exposes safe, typed APIs to renderer via contextBridge</purpose>
        <search-keywords>preload, contextBridge, IPC bridge, security, window.api, window.timesheet, window.auth, window.credentials, window.database, window.logger, type-safe IPC</search-keywords>
        <responsibilities>
          <item>Expose timesheet operations (submit, saveDraft, loadDraft, deleteDraft, exportToCSV)</item>
          <item>Expose credentials management (store, get, list, delete)</item>
          <item>Expose authentication operations (login, validateSession, logout, getCurrentSession)</item>
          <item>Expose admin operations (clearCredentials, rebuildDatabase)</item>
          <item>Expose database queries (getAllTimesheetEntries, getAllArchiveData)</item>
          <item>Expose logging bridge (error, warn, info, verbose, debug, userAction)</item>
          <item>Expose update event listeners (onUpdateAvailable, onDownloadProgress, onUpdateDownloaded)</item>
        </responsibilities>
        <key-exports>
          <export name="window.api">Ping API for testing</export>
          <export name="window.timesheet">Timesheet operations API</export>
          <export name="window.credentials">Credentials management API</export>
          <export name="window.auth">Authentication API</export>
          <export name="window.admin">Admin operations API</export>
          <export name="window.database">Database query API</export>
          <export name="window.logger">Logging API</export>
          <export name="window.updates">Update events API</export>
        </key-exports>
        <dependencies>
          <import>electron (contextBridge, ipcRenderer)</import>
        </dependencies>
        <data-flow>
          <input>Renderer function calls via exposed APIs</input>
          <output>IPC invocations to main process</output>
          <output>IPC event listeners for bi-directional communication</output>
        </data-flow>
      </file>
    </module>

    <!-- IPC Handlers -->
    <module name="ipc-handlers" description="IPC communication handlers (future refactoring - currently in main.ts)">
      <note>IPC handlers are currently implemented inline in main.ts within registerIPCHandlers(). Future refactoring will extract these to dedicated handler files.</note>
      
      <handler-group name="timesheet-handlers">
        <purpose>Handle timesheet-related IPC requests</purpose>
        <handlers>
          <handler name="timesheet:submit">Submit pending timesheet entries via automation</handler>
          <handler name="timesheet:saveDraft">Save a draft timesheet entry to database</handler>
          <handler name="timesheet:loadDraft">Load all draft timesheet entries</handler>
          <handler name="timesheet:deleteDraft">Delete a draft entry by ID</handler>
          <handler name="timesheet:exportToCSV">Export submitted entries to CSV format</handler>
        </handlers>
      </handler-group>

      <handler-group name="credentials-handlers">
        <purpose>Handle credential storage and retrieval</purpose>
        <handlers>
          <handler name="credentials:store">Store service credentials securely</handler>
          <handler name="credentials:get">Retrieve credentials for a service</handler>
          <handler name="credentials:list">List all stored credentials (email only)</handler>
          <handler name="credentials:delete">Delete credentials for a service</handler>
        </handlers>
      </handler-group>

      <handler-group name="auth-handlers">
        <purpose>Handle user authentication and session management</purpose>
        <handlers>
          <handler name="auth:login">Authenticate user and create session</handler>
          <handler name="auth:validateSession">Validate session token</handler>
          <handler name="auth:logout">Logout and clear session</handler>
          <handler name="auth:getCurrentSession">Get current session info</handler>
        </handlers>
      </handler-group>

      <handler-group name="admin-handlers">
        <purpose>Handle administrative operations</purpose>
        <handlers>
          <handler name="admin:clearCredentials">Clear all stored credentials</handler>
          <handler name="admin:rebuildDatabase">Rebuild database schema</handler>
        </handlers>
      </handler-group>

      <handler-group name="database-handlers">
        <purpose>Handle database query requests</purpose>
        <handlers>
          <handler name="database:getAllTimesheetEntries">Get all completed timesheet entries</handler>
          <handler name="database:getAllCredentials">Get all credentials (metadata only)</handler>
          <handler name="database:getAllArchiveData">Get both timesheet and credentials in one call</handler>
          <handler name="database:clearDatabase">Clear entire database (dev only)</handler>
        </handlers>
      </handler-group>

      <handler-group name="logs-handlers">
        <purpose>Handle log file operations</purpose>
        <handlers>
          <handler name="logs:getLogPath">Get path to current log file</handler>
          <handler name="logs:readLogFile">Read and parse log file contents</handler>
          <handler name="logs:exportLogs">Export logs in JSON or text format</handler>
        </handlers>
      </handler-group>

      <handler-group name="logger-handlers">
        <purpose>Bridge renderer logs to main process logger</purpose>
        <handlers>
          <handler name="logger:error">Log error from renderer</handler>
          <handler name="logger:warn">Log warning from renderer</handler>
          <handler name="logger:info">Log info from renderer</handler>
          <handler name="logger:verbose">Log verbose message from renderer</handler>
          <handler name="logger:debug">Log debug message from renderer</handler>
          <handler name="logger:user-action">Track user actions</handler>
        </handlers>
      </handler-group>
    </module>

    <!-- Services -->
    <module name="services" description="Business logic and external integrations">
      <keywords>services, business logic, database, timesheet-importer, plugins, bot automation, Playwright</keywords>
      <file path="app/backend/src/services/database.ts">
        <purpose>Central database management module providing SQLite connection, schema management, and all database operations</purpose>
        <search-keywords>database, SQLite, better-sqlite3, singleton connection, schema, ensureSchema, storeCredentials, getCredentials, createSession, validateSession, CRUD operations</search-keywords>
        <responsibilities>
          <item>Manage singleton database connection with connection pooling</item>
          <item>Initialize and maintain database schema</item>
          <item>Provide CRUD operations for timesheet entries</item>
          <item>Provide CRUD operations for credentials</item>
          <item>Provide CRUD operations for sessions</item>
          <item>Handle database path configuration</item>
          <item>Ensure thread safety for database operations</item>
        </responsibilities>
        <key-exports>
          <export name="setDbPath">Configure database file location</export>
          <export name="getDbPath">Get current database file location</export>
          <export name="getDb">Get singleton database connection</export>
          <export name="ensureSchema">Initialize database schema</export>
          <export name="storeCredentials">Store service credentials</export>
          <export name="getCredentials">Retrieve service credentials</export>
          <export name="listCredentials">List all credentials</export>
          <export name="deleteCredentials">Delete service credentials</export>
          <export name="createSession">Create user session</export>
          <export name="validateSession">Validate session token</export>
          <export name="clearSession">Clear session</export>
          <export name="clearUserSessions">Clear all sessions for user</export>
          <export name="clearAllCredentials">Clear all credentials (admin)</export>
          <export name="rebuildDatabase">Rebuild database schema</export>
          <export name="closeConnection">Close database connection</export>
        </key-exports>
        <dependencies>
          <import>better-sqlite3 - SQLite database driver</import>
          <import>../../../shared/logger - Logging system</import>
          <import>../../../shared/errors - Database error classes</import>
        </dependencies>
        <data-flow>
          <input>Database operations requests from IPC handlers and services</input>
          <output>SQLite file system writes</output>
          <output>Query results to callers</output>
        </data-flow>
      </file>

      <file path="app/backend/src/services/timesheet-importer.ts">
        <purpose>Orchestrates timesheet submission by coordinating database operations and submission service via plugin system</purpose>
        <search-keywords>timesheet importer, submission orchestration, submitTimesheets, plugin resolution, getSubmissionService, pending entries, in-progress status, submission results</search-keywords>
        <responsibilities>
          <item>Fetch pending timesheet entries from database</item>
          <item>Convert database format to TimesheetEntry format</item>
          <item>Resolve active submission service from plugin registry</item>
          <item>Coordinate submission process with progress callbacks</item>
          <item>Update database with submission results (success/failure)</item>
          <item>Mark entries as in-progress during submission</item>
          <item>Mark entries as submitted on success</item>
          <item>Revert failed entries back to pending status</item>
        </responsibilities>
        <key-exports>
          <export name="submitTimesheets">Submit all pending entries via active submission service</export>
          <export name="getPendingEntries">Get pending entries for review</export>
          <export name="getEntriesByIds">Get entries by ID array</export>
        </key-exports>
        <dependencies>
          <import>./database - Database operations</import>
          <import>../../../shared/logger - Logging system</import>
          <import>../middleware/bootstrap-plugins - Plugin resolution</import>
          <import>../../../shared/contracts/ISubmissionService - Submission contract</import>
        </dependencies>
        <data-flow>
          <input>Credentials and progress callback from IPC handler</input>
          <input>Pending entries from database</input>
          <output>Submission requests to plugin service</output>
          <output>Database status updates</output>
          <output>Submission result to caller</output>
        </data-flow>
      </file>

      <module name="plugins" description="Plugin implementations for data, credentials, and submission services">
        <keywords>plugins, IDataService, ICredentialService, ISubmissionService, SQLite, Playwright, mock service</keywords>
        <file path="app/backend/src/services/plugins/sqlite-data-service.ts">
          <purpose>SQLite implementation of IDataService contract for timesheet data persistence</purpose>
          <implements>IDataService from shared/contracts</implements>
        </file>

        <file path="app/backend/src/services/plugins/memory-data-service.ts">
          <purpose>In-memory implementation of IDataService for testing</purpose>
          <implements>IDataService from shared/contracts</implements>
        </file>

        <file path="app/backend/src/services/plugins/sqlite-credential-service.ts">
          <purpose>SQLite implementation of ICredentialService contract for credential storage</purpose>
          <implements>ICredentialService from shared/contracts</implements>
        </file>

        <file path="app/backend/src/services/plugins/playwright-bot-service.ts">
          <purpose>Playwright-based browser automation implementation of ISubmissionService</purpose>
          <implements>ISubmissionService from shared/contracts</implements>
          <search-keywords>PlaywrightBotService, browser automation, Playwright, headless browser, bot service, submission plugin, ISubmissionService</search-keywords>
          <responsibilities>
            <item>Launch headless browser via Playwright</item>
            <item>Navigate to timesheet web forms</item>
            <item>Authenticate with provided credentials</item>
            <item>Fill and submit timesheet data</item>
            <item>Handle form validation and errors</item>
            <item>Report submission progress</item>
          </responsibilities>
        </file>

        <file path="app/backend/src/services/plugins/mock-submission-service.ts">
          <purpose>Mock implementation of ISubmissionService for testing without actual submission</purpose>
          <implements>ISubmissionService from shared/contracts</implements>
        </file>
      </module>

      <module name="bot" description="Browser automation bot implementation">
        <keywords>bot, browser automation, Playwright, webform, authentication, quarter routing</keywords>
        <file path="app/backend/src/services/bot/src/bot_orchestation.ts">
          <purpose>Orchestrates the entire browser automation workflow for timesheet submission</purpose>
          <search-keywords>bot orchestration, workflow coordinator, browser launch, quarter grouping, authentication flow, webform flow, progress reporting</search-keywords>
          <responsibilities>
            <item>Group timesheet entries by quarter</item>
            <item>Launch and manage browser instance</item>
            <item>Execute authentication flow</item>
            <item>Execute webform fill and submission flow</item>
            <item>Handle retries and error recovery</item>
            <item>Report progress throughout submission</item>
          </responsibilities>
        </file>

        <file path="app/backend/src/services/bot/src/authentication_flow.ts">
          <purpose>Handles authentication process on timesheet web portal</purpose>
          <search-keywords>authentication flow, web portal login, credentials form, login navigation, authentication errors, verify login</search-keywords>
          <responsibilities>
            <item>Navigate to login page</item>
            <item>Fill credentials form</item>
            <item>Submit login form</item>
            <item>Verify successful authentication</item>
            <item>Handle authentication errors</item>
          </responsibilities>
        </file>

        <file path="app/backend/src/services/bot/src/webform_flow.ts">
          <purpose>Handles timesheet web form interaction and submission</purpose>
          <search-keywords>webform flow, form filling, cascading dropdowns, field population, submit entry, form validation, quarter form navigation</search-keywords>
          <responsibilities>
            <item>Navigate to correct quarter form</item>
            <item>Fill timesheet entry fields (date, time, project, etc.)</item>
            <item>Handle cascading dropdowns</item>
            <item>Submit individual entries</item>
            <item>Verify submission success</item>
            <item>Handle form validation errors</item>
          </responsibilities>
        </file>

        <file path="app/backend/src/services/bot/src/quarter_config.ts">
          <purpose>Manages quarter-based routing configuration for different timesheet forms</purpose>
          <responsibilities>
            <item>Define quarter date ranges</item>
            <item>Map quarters to form URLs/IDs</item>
            <item>Determine which quarter an entry belongs to</item>
          </responsibilities>
        </file>

        <file path="app/backend/src/services/bot/src/automation_config.ts">
          <purpose>Central configuration for automation behavior (timeouts, retries, selectors)</purpose>
        </file>

        <file path="app/backend/src/services/bot/src/index.ts">
          <purpose>Export entry point for bot service</purpose>
        </file>
      </module>
    </module>

    <!-- Repositories -->
    <module name="repositories" description="Data access layer abstractions">
      <file path="app/backend/src/repositories/connection-manager.ts">
        <purpose>Manages database connection lifecycle and provides connection accessor</purpose>
        <key-exports>
          <export name="getDb">Get active database connection</export>
          <export name="closeConnection">Close database connection</export>
        </key-exports>
      </file>

      <file path="app/backend/src/repositories/timesheet-repository.ts">
        <purpose>Repository for timesheet-specific database operations</purpose>
        <key-exports>
          <export name="insertTimesheetEntry">Insert new timesheet entry with deduplication</export>
          <export name="getPendingTimesheetEntries">Get all pending entries</export>
          <export name="markTimesheetEntriesAsInProgress">Mark entries as in-progress</export>
          <export name="markTimesheetEntriesAsSubmitted">Mark entries as successfully submitted</export>
          <export name="removeFailedTimesheetEntries">Revert failed entries to pending</export>
          <export name="getTimesheetEntriesByIds">Get entries by ID array</export>
          <export name="getSubmittedTimesheetEntriesForExport">Get submitted entries for CSV export</export>
        </key-exports>
      </file>

      <file path="app/backend/src/repositories/credentials-repository.ts">
        <purpose>Repository for credentials-specific database operations</purpose>
      </file>

      <file path="app/backend/src/repositories/session-repository.ts">
        <purpose>Repository for session-specific database operations</purpose>
      </file>
    </module>

    <!-- Middleware -->
    <module name="middleware" description="Plugin system and middleware logic">
      <keywords>middleware, plugin system, bootstrap, plugin registration, plugin resolution</keywords>
      <file path="app/backend/src/middleware/bootstrap-plugins.ts">
        <purpose>Registers all default plugins with the plugin registry during application startup</purpose>
        <search-keywords>bootstrap plugins, plugin registration, registerDefaultPlugins, plugin-config.json, getDataService, getCredentialService, getSubmissionService, plugin resolver</search-keywords>
        <responsibilities>
          <item>Load plugin configuration from plugin-config.json</item>
          <item>Register data service plugins (sqlite, memory)</item>
          <item>Register credential service plugins (sqlite)</item>
          <item>Register submission service plugins (playwright, mock)</item>
          <item>Configure active plugins per namespace</item>
        </responsibilities>
        <key-exports>
          <export name="registerDefaultPlugins">Initialize and register all plugins</export>
          <export name="getDataService">Get active data service from registry</export>
          <export name="getCredentialService">Get active credential service from registry</export>
          <export name="getSubmissionService">Get active submission service from registry</export>
        </key-exports>
        <dependencies>
          <import>../../../shared/plugin-registry - Plugin registry system</import>
          <import>../../../shared/plugin-config - Configuration loader</import>
          <import>Plugin implementations from services/plugins/</import>
        </dependencies>
        <data-flow>
          <input>Plugin configuration from JSON file</input>
          <output>Registered plugins in singleton registry</output>
        </data-flow>
      </file>
    </module>

    <!-- Logic -->
    <module name="logic" description="Business logic and validation">
      <file path="app/backend/src/logic/timesheet-validation.ts">
        <purpose>Validation logic for timesheet entries (format, ranges, required fields)</purpose>
      </file>

      <file path="app/backend/src/logic/timesheet-normalization.ts">
        <purpose>Normalization logic for timesheet data (date formats, time formats)</purpose>
      </file>

      <file path="app/backend/src/logic/dropdown-logic.ts">
        <purpose>Business logic for cascading dropdown dependencies (project → tool → charge code)</purpose>
      </file>
    </module>

    <!-- Validation -->
    <module name="validation" description="IPC input validation">
      <file path="app/backend/src/validation/ipc-schemas.ts">
        <purpose>Zod schemas for validating IPC request payloads</purpose>
      </file>

      <file path="app/backend/src/validation/validate-ipc-input.ts">
        <purpose>Validation functions for IPC inputs using defined schemas</purpose>
      </file>
    </module>
  </layer>

  <!-- ==================== FRONTEND LAYER ==================== -->
  <layer name="frontend" type="electron-renderer" description="React-based renderer process - handles UI, user interactions, and state management">
    <keywords>frontend, React, renderer process, UI, components, contexts, state management, Handsontable, Material-UI, lazy loading</keywords>
    
    <!-- Entry Points -->
    <module name="entry-points" description="Application entry and root component">
      <keywords>entry points, main.tsx, App.tsx, React root, theme provider, navigation, Suspense</keywords>
      <file path="app/frontend/src/main.tsx">
        <purpose>Frontend entry point - initializes React app, fallbacks, error handlers, and theme</purpose>
        <search-keywords>frontend entry, React root, ReactDOM, MUI theme, error handlers, logger fallback, API fallback, safe init, startup performance</search-keywords>
        <responsibilities>
          <item>Initialize logger and API fallbacks for development mode</item>
          <item>Set up global error handlers (unhandled errors and promise rejections)</item>
          <item>Monitor startup performance</item>
          <item>Configure MUI theme provider</item>
          <item>Mount App or Splash component based on URL hash</item>
        </responsibilities>
        <key-exports>
          <export name="React root">Renders App or Splash component</export>
        </key-exports>
        <dependencies>
          <import>react-dom/client - React rendering</import>
          <import>@mui/material - Material-UI components</import>
          <import>./App - Main application component</import>
          <import>./utils/logger-fallback - Development logging fallback</import>
          <import>./utils/api-fallback - Development API fallback</import>
          <import>./utils/safe-init - Idempotent initialization</import>
        </dependencies>
        <data-flow>
          <input>URL hash to determine mount mode (app vs splash)</input>
          <output>Mounted React application</output>
          <output>Console/IPC logs for errors</output>
        </data-flow>
      </file>

      <file path="app/frontend/src/App.tsx">
        <purpose>Root application component - manages navigation, authentication, dialogs, and main content area</purpose>
        <search-keywords>App, root component, navigation, tab management, LoginDialog, UpdateDialog, AboutDialog, Suspense, lazy loading, batch save, activeTab</search-keywords>
        <responsibilities>
          <item>Manage navigation between Timesheet, Archive, and Help tabs</item>
          <item>Control authentication state via LoginDialog</item>
          <item>Handle page transitions with animations</item>
          <item>Manage About dialog display</item>
          <item>Manage UpdateDialog for auto-updates</item>
          <item>Initialize theme on mount</item>
          <item>Lazy load components with Suspense</item>
          <item>Trigger data refreshes on tab changes</item>
          <item>Coordinate batch saves when leaving Timesheet tab</item>
        </responsibilities>
        <key-exports>
          <export name="App">Default export - main app component wrapped in providers</export>
          <export name="AppContent">Inner component with navigation logic</export>
          <export name="AboutBody">About dialog content</export>
          <export name="Splash">Splash screen for auto-updates</export>
        </key-exports>
        <dependencies>
          <import>./contexts/DataContext - Data state management</import>
          <import>./contexts/SessionContext - Auth state management</import>
          <import>./components/SheetPilotNavigation - Navigation bar</import>
          <import>./components/timesheet/TimesheetGrid - Timesheet UI (lazy)</import>
          <import>./components/archive/DatabaseViewer - Archive UI (lazy)</import>
          <import>./components/Help - Help documentation (lazy)</import>
          <import>./components/LoginDialog - Authentication dialog</import>
          <import>./components/UpdateDialog - Auto-update dialog</import>
          <import>./utils/theme-manager - Theme initialization</import>
        </dependencies>
        <data-flow>
          <input>User navigation actions</input>
          <input>Authentication state changes</input>
          <input>Update events from main process</input>
          <output>Navigation state changes</output>
          <output>Data refresh requests to contexts</output>
          <output>Batch save requests to TimesheetGrid</output>
        </data-flow>
      </file>
    </module>

    <!-- Contexts -->
    <module name="contexts" description="React context providers for global state management">
      <keywords>contexts, state management, SessionContext, DataContext, React Context API, global state, providers</keywords>
      <file path="app/frontend/src/contexts/SessionContext.tsx">
        <purpose>Manages user authentication state and session persistence</purpose>
        <search-keywords>SessionContext, authentication state, session token, localStorage persistence, login, logout, isLoggedIn, isAdmin, session restoration</search-keywords>
        <responsibilities>
          <item>Store session token, email, and isAdmin flag in state</item>
          <item>Persist session token to localStorage</item>
          <item>Restore session from localStorage on app startup</item>
          <item>Validate session token with backend on restoration</item>
          <item>Provide login function to create new session</item>
          <item>Provide logout function to clear session</item>
          <item>Expose loading state during session validation</item>
        </responsibilities>
        <key-exports>
          <export name="SessionProvider">Context provider component</export>
          <export name="useSession">Hook to access session state and functions</export>
        </key-exports>
        <context-value>
          <field name="isLoggedIn">Boolean indicating if user is authenticated</field>
          <field name="token">Session token string or null</field>
          <field name="email">User email or null</field>
          <field name="isAdmin">Boolean indicating admin status</field>
          <field name="login">Function to create session</field>
          <field name="logout">Function to clear session</field>
          <field name="isLoading">Boolean indicating session validation in progress</field>
        </context-value>
        <dependencies>
          <import>window.auth - IPC authentication API from preload</import>
          <import>window.logger - IPC logging API from preload</import>
        </dependencies>
        <data-flow>
          <input>Login credentials from LoginDialog</input>
          <input>Session token from localStorage</input>
          <output>Session validation IPC calls</output>
          <output>Logout IPC calls</output>
          <output>localStorage writes</output>
        </data-flow>
      </file>

      <file path="app/frontend/src/contexts/DataContext.tsx">
        <purpose>Manages timesheet draft data and archive data with lazy loading and caching</purpose>
        <search-keywords>DataContext, timesheet draft data, archive data, lazy loading, localStorage backup, refreshTimesheetDraft, refreshArchiveData, data resilience, loading states</search-keywords>
        <responsibilities>
          <item>Store timesheet draft data (pending entries) in state</item>
          <item>Store archive data (completed entries and credentials) in state</item>
          <item>Provide lazy loading - data loads only when user navigates to tabs</item>
          <item>Implement localStorage backup for draft data resilience</item>
          <item>Restore from localStorage backup on database errors</item>
          <item>Provide refresh functions to reload data on demand</item>
          <item>Yield to main thread during heavy operations to prevent UI blocking</item>
          <item>Process large datasets in chunks</item>
          <item>Expose loading and error states</item>
        </responsibilities>
        <key-exports>
          <export name="DataProvider">Context provider component</export>
          <export name="useData">Hook to access data state and functions</export>
        </key-exports>
        <context-value>
          <field name="timesheetDraftData">Array of draft timesheet rows</field>
          <field name="setTimesheetDraftData">Function to update draft data</field>
          <field name="refreshTimesheetDraft">Function to reload draft data</field>
          <field name="archiveData">Object containing timesheet and credentials arrays</field>
          <field name="setArchiveData">Function to update archive data</field>
          <field name="refreshArchiveData">Function to reload archive data</field>
          <field name="isTimesheetDraftLoading">Loading state for draft data</field>
          <field name="isArchiveDataLoading">Loading state for archive data</field>
          <field name="timesheetDraftError">Error message for draft data</field>
          <field name="archiveDataError">Error message for archive data</field>
        </context-value>
        <dependencies>
          <import>./SessionContext - For session token</import>
          <import>window.timesheet - IPC timesheet API from preload</import>
          <import>window.database - IPC database API from preload</import>
          <import>window.logger - IPC logging API from preload</import>
        </dependencies>
        <data-flow>
          <input>Refresh requests from App component</input>
          <input>Session token from SessionContext</input>
          <output>IPC calls to load draft data</output>
          <output>IPC calls to load archive data</output>
          <output>localStorage backup writes</output>
        </data-flow>
      </file>
    </module>

    <!-- Components -->
    <module name="components" description="React UI components">
      <keywords>components, UI, React components, navigation, LoginDialog, UpdateDialog, TimesheetGrid, DatabaseViewer, Handsontable</keywords>
      <file path="app/frontend/src/components/SheetPilotNavigation.tsx">
        <purpose>Main navigation bar with logo, tab buttons, and user menu</purpose>
        <responsibilities>
          <item>Display application logo (clickable for About dialog)</item>
          <item>Render tab buttons for Timesheet, Archive, Help</item>
          <item>Highlight active tab</item>
          <item>Emit tab change events</item>
          <item>Display user menu with logout option</item>
          <item>Show admin badge if user is admin</item>
        </responsibilities>
      </file>

      <file path="app/frontend/src/components/LoginDialog.tsx">
        <purpose>Authentication dialog for user login</purpose>
        <responsibilities>
          <item>Display login form (email, password, stay logged in)</item>
          <item>Validate input fields</item>
          <item>Call auth IPC API for login</item>
          <item>Handle login errors and display messages</item>
          <item>Emit login success event</item>
          <item>Support admin login (Admin/SWFL_ADMIN)</item>
        </responsibilities>
      </file>

      <file path="app/frontend/src/components/UpdateDialog.tsx">
        <purpose>Dialog showing auto-update download and installation progress</purpose>
        <responsibilities>
          <item>Display update version</item>
          <item>Show progress bar during download</item>
          <item>Show status message (downloading/installing)</item>
          <item>Provide cancel button during download</item>
        </responsibilities>
      </file>

      <module name="timesheet" description="Timesheet-specific components">
        <keywords>timesheet components, TimesheetGrid, Handsontable, MacroManager, validation, persistence, submission</keywords>
        <file path="app/frontend/src/components/timesheet/TimesheetGrid.tsx">
          <purpose>Main timesheet data grid using Handsontable for spreadsheet-like editing</purpose>
          <search-keywords>TimesheetGrid, Handsontable, spreadsheet grid, cell editing, afterChange, debounced save, batch save, validation, context menu, row deletion, StatusButton</search-keywords>
          <responsibilities>
            <item>Render Handsontable grid with timesheet columns</item>
            <item>Configure column types (date, time, dropdown, text)</item>
            <item>Implement data validation (time increments, required fields)</item>
            <item>Handle cell changes and trigger saves</item>
            <item>Debounce saves to prevent excessive database writes</item>
            <item>Provide batch save function for exiting tab</item>
            <item>Handle submission via StatusButton</item>
            <item>Load draft data from DataContext</item>
            <item>Support row deletion with right-click menu</item>
            <item>Display validation errors inline</item>
          </responsibilities>
          <key-exports>
            <export name="TimesheetGrid">Main component</export>
            <export name="TimesheetGridHandle">Ref handle with batchSaveToDatabase method</export>
          </key-exports>
        </file>

        <file path="app/frontend/src/components/timesheet/timesheet.validation.ts">
          <purpose>Client-side validation logic for timesheet entries</purpose>
        </file>

        <file path="app/frontend/src/components/timesheet/timesheet.persistence.ts">
          <purpose>Persistence layer for saving timesheet data via IPC</purpose>
        </file>

        <file path="app/frontend/src/components/timesheet/timesheet.schema.ts">
          <purpose>Data schema and types for timesheet grid</purpose>
        </file>

        <file path="app/frontend/src/components/timesheet/timesheet.options.ts">
          <purpose>Handsontable configuration options</purpose>
        </file>

        <file path="app/frontend/src/components/timesheet/timesheet.submit.ts">
          <purpose>Submission logic for timesheet entries</purpose>
        </file>

        <file path="app/frontend/src/components/timesheet/MacroManagerDialog.tsx">
          <purpose>Dialog for managing saved macros (quick-fill templates)</purpose>
        </file>

        <file path="app/frontend/src/components/timesheet/SpellcheckEditor.ts">
          <purpose>Custom Handsontable editor with spellcheck support</purpose>
        </file>
      </module>

      <file path="app/frontend/src/components/StatusButton.tsx">
        <purpose>Submit button component with progress indication and status display</purpose>
        <search-keywords>StatusButton, submission button, progress indicator, submit timesheet, success state, error state, submission feedback</search-keywords>
        <responsibilities>
          <item>Display submit button when data is ready</item>
          <item>Show progress during submission</item>
          <item>Display success/error states</item>
          <item>Trigger submission via IPC</item>
        </responsibilities>
      </file>

      <file path="app/frontend/src/components/SubmitProgressBar.tsx">
        <purpose>Progress bar component for submission progress</purpose>
      </file>

      <file path="app/frontend/src/components/Help.tsx">
        <purpose>Help and documentation viewer component</purpose>
      </file>

      <file path="app/frontend/src/components/UserManual.tsx">
        <purpose>User manual content component</purpose>
      </file>

      <file path="app/frontend/src/components/KeyboardShortcutsHintDialog.tsx">
        <purpose>Dialog displaying keyboard shortcuts</purpose>
      </file>

      <file path="app/frontend/src/components/archive/DatabaseViewer.tsx">
        <purpose>Archive viewer showing completed timesheet entries and stored credentials</purpose>
        <search-keywords>DatabaseViewer, archive viewer, completed entries, credentials table, CSV export, historical data, search, filter</search-keywords>
        <responsibilities>
          <item>Load archive data from DataContext</item>
          <item>Display completed timesheet entries in table</item>
          <item>Display stored credentials in table</item>
          <item>Provide CSV export functionality</item>
          <item>Provide search/filter capabilities</item>
        </responsibilities>
      </file>

      <module name="skeletons" description="Loading skeleton components">
        <file path="app/frontend/src/components/skeletons/TimesheetSkeleton.tsx">
          <purpose>Loading skeleton for Timesheet tab</purpose>
        </file>
        <file path="app/frontend/src/components/skeletons/ArchiveSkeleton.tsx">
          <purpose>Loading skeleton for Archive tab</purpose>
        </file>
        <file path="app/frontend/src/components/skeletons/HelpSkeleton.tsx">
          <purpose>Loading skeleton for Help tab</purpose>
        </file>
      </module>
    </module>

    <!-- Hooks -->
    <module name="hooks" description="Custom React hooks">
      <keywords>hooks, custom hooks, useTheme, React hooks, theme management</keywords>
      <file path="app/frontend/src/hooks/useTheme.ts">
        <purpose>Custom hook for theme management (light/dark mode toggle)</purpose>
        <responsibilities>
          <item>Read theme preference from localStorage</item>
          <item>Apply theme to document body</item>
          <item>Provide toggle function</item>
          <item>Persist theme changes to localStorage</item>
        </responsibilities>
      </file>
    </module>

    <!-- Utils -->
    <module name="utils" description="Utility functions and helpers">
      <keywords>utils, utilities, helpers, theme manager, logger fallback, API fallback, macroStorage, smartDate</keywords>
      <file path="app/frontend/src/utils/theme-manager.ts">
        <purpose>Theme initialization and management utilities</purpose>
        <responsibilities>
          <item>Initialize theme on app startup</item>
          <item>Detect system theme preference</item>
          <item>Apply theme CSS variables</item>
        </responsibilities>
      </file>

      <file path="app/frontend/src/utils/logger-fallback.ts">
        <purpose>Development fallback for window.logger API when running without Electron</purpose>
        <search-keywords>logger fallback, development fallback, console logger, window.logger mock, log levels, userAction tracking</search-keywords>
        <responsibilities>
          <item>Provide console-based logger when window.logger is undefined</item>
          <item>Support all log levels (error, warn, info, verbose, debug)</item>
          <item>Support userAction tracking</item>
        </responsibilities>
      </file>

      <file path="app/frontend/src/utils/api-fallback.ts">
        <purpose>Development fallback for window.api when running without Electron</purpose>
        <search-keywords>API fallback, development fallback, mock IPC, window API mock, placeholder data, development mode</search-keywords>
        <responsibilities>
          <item>Provide mock implementations of IPC APIs</item>
          <item>Return placeholder data for testing</item>
          <item>Log API calls to console</item>
        </responsibilities>
      </file>

      <file path="app/frontend/src/utils/safe-init.ts">
        <purpose>Idempotent initialization utility to prevent duplicate runs</purpose>
        <responsibilities>
          <item>Track which initialization functions have run</item>
          <item>Prevent duplicate execution</item>
          <item>Useful for React StrictMode and HMR</item>
        </responsibilities>
      </file>

      <file path="app/frontend/src/utils/smartDate.ts">
        <purpose>Smart date parsing utility for user-friendly date input</purpose>
        <responsibilities>
          <item>Parse relative dates (today, tomorrow, yesterday)</item>
          <item>Parse date shortcuts (3/15, 12/25)</item>
          <item>Parse full dates (MM/DD/YYYY)</item>
          <item>Return standardized date strings</item>
        </responsibilities>
      </file>

      <file path="app/frontend/src/utils/macroStorage.ts">
        <purpose>LocalStorage-based macro storage for quick-fill templates</purpose>
        <search-keywords>macroStorage, localStorage, macros, quick-fill templates, saved patterns, macro management</search-keywords>
        <responsibilities>
          <item>Save macros to localStorage</item>
          <item>Load macros from localStorage</item>
          <item>Delete macros</item>
          <item>List all saved macros</item>
        </responsibilities>
      </file>
    </module>

    <!-- Contracts -->
    <module name="contracts" description="TypeScript interfaces and type definitions">
      <file path="app/frontend/src/contracts/window.ts">
        <purpose>TypeScript declarations for window object extensions (IPC APIs)</purpose>
        <responsibilities>
          <item>Declare window.api interface</item>
          <item>Declare window.timesheet interface</item>
          <item>Declare window.credentials interface</item>
          <item>Declare window.auth interface</item>
          <item>Declare window.admin interface</item>
          <item>Declare window.database interface</item>
          <item>Declare window.logger interface</item>
          <item>Declare window.updates interface</item>
        </responsibilities>
      </file>

      <file path="app/frontend/src/contracts/ITimesheetGrid.ts">
        <purpose>Interface for TimesheetGrid component API</purpose>
      </file>

      <file path="app/frontend/src/contracts/IGridAdapter.ts">
        <purpose>Interface for Handsontable adapter</purpose>
      </file>
    </module>

    <!-- Styles -->
    <module name="styles" description="CSS stylesheets">
      <file path="app/frontend/src/styles/m3-tokens.css">
        <purpose>Material Design 3 design tokens (colors, typography, spacing, etc.)</purpose>
      </file>

      <file path="app/frontend/src/styles/theme.css">
        <purpose>Theme-specific overrides and component patterns</purpose>
      </file>

      <file path="app/frontend/src/styles/m3-components.css">
        <purpose>Material Design 3 component styles</purpose>
      </file>

      <file path="app/frontend/src/styles/m3-mui-overrides.css">
        <purpose>Material-UI component overrides to match M3 design</purpose>
      </file>

      <file path="app/frontend/src/styles/App.css">
        <purpose>Main application layout styles</purpose>
      </file>

      <file path="app/frontend/src/styles/transitions.css">
        <purpose>Page transition animations</purpose>
      </file>

      <file path="app/frontend/src/styles/index.css">
        <purpose>Global styles and CSS reset</purpose>
      </file>
    </module>
  </layer>

  <!-- ==================== SHARED LAYER ==================== -->
  <layer name="shared" type="common" description="Code shared between backend and frontend">
    <keywords>shared, contracts, interfaces, plugin system, plugin registry, logger, error handling, configuration</keywords>
    
    <!-- Contracts -->
    <module name="contracts" description="Service interface definitions">
      <keywords>contracts, interfaces, IDataService, ISubmissionService, ICredentialService, ILoggingService, service contracts</keywords>
      <file path="app/shared/contracts/IDataService.ts">
        <purpose>Interface contract for data persistence services</purpose>
        <search-keywords>IDataService, data persistence contract, plugin interface, saveDraft, loadDraft, deleteDraft, getArchiveData</search-keywords>
        <methods>
          <method name="saveDraft">Save a draft timesheet entry</method>
          <method name="loadDraft">Load all draft entries</method>
          <method name="deleteDraft">Delete a draft entry</method>
          <method name="getArchiveData">Get completed entries and credentials</method>
          <method name="getAllTimesheetEntries">Get all entries for viewer</method>
        </methods>
        <implements>IPlugin</implements>
      </file>

      <file path="app/shared/contracts/ISubmissionService.ts">
        <purpose>Interface contract for timesheet submission services</purpose>
        <search-keywords>ISubmissionService, submission contract, plugin interface, submit, validateEntry, isAvailable, browser automation contract</search-keywords>
        <methods>
          <method name="submit">Submit timesheet entries with credentials</method>
          <method name="validateEntry">Validate entry before submission</method>
          <method name="isAvailable">Check if service is available</method>
        </methods>
        <implements>IPlugin</implements>
      </file>

      <file path="app/shared/contracts/ICredentialService.ts">
        <purpose>Interface contract for credential storage services</purpose>
        <search-keywords>ICredentialService, credentials contract, plugin interface, store, get, list, delete, credential management</search-keywords>
        <methods>
          <method name="store">Store service credentials</method>
          <method name="get">Retrieve service credentials</method>
          <method name="list">List all stored credentials</method>
          <method name="delete">Delete service credentials</method>
        </methods>
        <implements>IPlugin</implements>
      </file>

      <file path="app/shared/contracts/ILoggingService.ts">
        <purpose>Interface contract for logging services</purpose>
      </file>
    </module>

    <!-- Plugin System -->
    <module name="plugin-system" description="Plugin registry and type definitions">
      <keywords>plugin system, plugin registry, singleton, namespaces, plugin types, configuration, IPlugin, PluginMetadata</keywords>
      <file path="app/shared/plugin-registry.ts">
        <purpose>Central plugin registry implementing singleton pattern for plugin management</purpose>
        <search-keywords>PluginRegistry, singleton, registerPlugin, getPlugin, setActivePlugin, plugin resolution, namespaces, lifecycle management</search-keywords>
        <responsibilities>
          <item>Maintain registry of all plugins organized by namespace</item>
          <item>Track active plugin per namespace</item>
          <item>Provide plugin registration API</item>
          <item>Provide plugin resolution API (with fallback support)</item>
          <item>Handle plugin lifecycle (initialize, dispose)</item>
          <item>Load and manage plugin configuration</item>
          <item>Support feature flags</item>
        </responsibilities>
        <key-exports>
          <export name="PluginRegistry">Singleton class for plugin management</export>
          <export name="getInstance">Get singleton instance</export>
          <export name="registerPlugin">Register a plugin</export>
          <export name="getPlugin">Retrieve a plugin by namespace/name</export>
          <export name="getPluginWithFallback">Retrieve plugin with fallback</export>
          <export name="setActivePlugin">Set active plugin for namespace</export>
          <export name="listPlugins">List all plugins in namespace</export>
          <export name="hasPlugin">Check if plugin exists</export>
        </key-exports>
        <data-flow>
          <input>Plugin registrations from bootstrap-plugins</input>
          <input>Plugin configuration from plugin-config.json</input>
          <output>Plugin instance resolution for services</output>
        </data-flow>
      </file>

      <file path="app/shared/plugin-types.ts">
        <purpose>TypeScript type definitions for plugin system</purpose>
        <search-keywords>plugin types, IPlugin, PluginMetadata, PluginConfiguration, PluginRegistryConfig, FeatureFlag, type definitions</search-keywords>
        <key-exports>
          <export name="IPlugin">Base plugin interface with initialize/dispose</export>
          <export name="PluginMetadata">Plugin metadata structure</export>
          <export name="PluginConfiguration">Plugin configuration structure</export>
          <export name="PluginRegistryConfig">Registry configuration structure</export>
          <export name="FeatureFlag">Feature flag configuration</export>
        </key-exports>
      </file>

      <file path="app/shared/plugin-config.ts">
        <purpose>Plugin configuration loader and validator</purpose>
        <search-keywords>plugin config, configuration loader, loadPluginConfig, getDefaultConfig, plugin-config.json, validation</search-keywords>
        <responsibilities>
          <item>Load plugin configuration from JSON file</item>
          <item>Validate configuration structure</item>
          <item>Provide default configuration</item>
          <item>Handle missing configuration gracefully</item>
        </responsibilities>
        <key-exports>
          <export name="loadPluginConfig">Load configuration from file</export>
          <export name="getDefaultConfig">Get default configuration</export>
        </key-exports>
      </file>
    </module>

    <!-- Configuration -->
    <module name="configuration" description="Application configuration and constants">
      <keywords>configuration, constants, business config, APP_VERSION, APP_NAME, dropdown options, validation rules</keywords>
      <file path="app/shared/constants.ts">
        <purpose>Application-wide constants (version, app name, etc.)</purpose>
        <key-exports>
          <export name="APP_VERSION">Application version string</export>
          <export name="APP_NAME">Application name</export>
        </key-exports>
      </file>

      <file path="app/shared/business-config.ts">
        <purpose>Business logic configuration (dropdown options, validation rules, etc.)</purpose>
        <search-keywords>business config, dropdown options, project options, tool options, charge codes, validation rules, cascading dropdowns</search-keywords>
        <responsibilities>
          <item>Define project dropdown options</item>
          <item>Define tool dropdown options per project</item>
          <item>Define charge code options per project/tool</item>
          <item>Define validation rules</item>
        </responsibilities>
      </file>
    </module>

    <!-- Error Handling -->
    <module name="error-handling" description="Error classes and utilities">
      <keywords>error handling, custom errors, AppError, DatabaseConnectionError, CredentialsNotFoundError, error codes, structured errors</keywords>
      <file path="app/shared/errors.ts">
        <purpose>Custom error classes for application-specific errors</purpose>
        <search-keywords>errors, AppError, DatabaseConnectionError, DatabaseSchemaError, CredentialsNotFoundError, error codes, isAppError, createUserFriendlyMessage</search-keywords>
        <key-exports>
          <export name="AppError">Base application error class</export>
          <export name="DatabaseConnectionError">Database connection error</export>
          <export name="DatabaseSchemaError">Database schema error</export>
          <export name="CredentialsNotFoundError">Credentials not found error</export>
          <export name="CredentialsStorageError">Credentials storage error</export>
          <export name="isAppError">Type guard for AppError</export>
          <export name="extractErrorCode">Extract error code from error</export>
          <export name="createUserFriendlyMessage">Convert error to user-friendly message</export>
        </key-exports>
      </file>
    </module>

    <!-- Logging -->
    <module name="logging" description="Centralized logging system">
      <keywords>logging, logger, electron-log, structured logging, NDJSON, appLogger, dbLogger, ipcLogger, botLogger, PII redaction</keywords>
      <file path="app/shared/logger.ts">
        <purpose>Centralized logging system using electron-log with structured logging</purpose>
        <search-keywords>logger, electron-log, structured logging, NDJSON, appLogger, dbLogger, ipcLogger, botLogger, log levels, audit logging, security logging, performance timing, PII protection</search-keywords>
        <responsibilities>
          <item>Initialize electron-log with appropriate configuration</item>
          <item>Provide component-specific loggers (appLogger, dbLogger, ipcLogger, botLogger)</item>
          <item>Support multiple log levels (error, warn, info, verbose, debug, silly)</item>
          <item>Support structured logging with metadata</item>
          <item>Support audit logging for security-sensitive operations</item>
          <item>Support security logging for authentication events</item>
          <item>Support performance timing with startTimer/done</item>
          <item>Write logs to file in NDJSON format (newline-delimited JSON)</item>
          <item>Include context (session ID, username, environment, etc.)</item>
          <item>Redact sensitive information (PII protection)</item>
        </responsibilities>
        <key-exports>
          <export name="initializeLogging">Initialize logging system</export>
          <export name="appLogger">Application logger</export>
          <export name="dbLogger">Database logger</export>
          <export name="ipcLogger">IPC logger</export>
          <export name="botLogger">Bot/automation logger</export>
        </key-exports>
      </file>
    </module>

    <!-- Index -->
    <file path="app/shared/index.ts">
      <purpose>Central export point for shared module</purpose>
      <exports>
        <export from="./business-config">Business configuration</export>
        <export from="./constants">Constants</export>
        <export from="./errors">Error classes</export>
        <export from="./logger">Logging system</export>
        <export from="./plugin-config">Plugin configuration</export>
        <export from="./plugin-registry">Plugin registry</export>
        <export from="./plugin-types">Plugin types</export>
        <export from="./contracts/*">All contracts</export>
      </exports>
    </file>
  </layer>
</application>

