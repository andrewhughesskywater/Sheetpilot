# Auto-Update Configuration

## Overview

Sheetpilot uses `electron-updater` for seamless, atomic auto-updates. Updates are hosted on a network drive and installed automatically during app startup.

## How It Works

1. **Startup Check**: When the app starts (in production mode), it checks the network drive for updates
2. **Automatic Download**: If an update is available, it downloads in the background
3. **Atomic Installation**: The update installs automatically when the user quits the app
4. **Rollback Safety**: If the update fails, the app reverts to the previous version

## Setup Instructions

### 1. Configure Network Drive Path

You need to update two files with your actual network drive path:

#### package.json

```json
"publish": {
  "provider": "generic",
  "url": "file://\\\\SERVER\\Share\\sheetpilot-updates"
}
```

#### dev-app-update.yml (for development testing)

```yaml
provider: generic
url: file://\\\\SERVER\\Share\\sheetpilot-updates
```

Replace `\\\\SERVER\\Share\\sheetpilot-updates` with your actual network path.

#### Network Path Format Examples

- UNC path: `file://\\\\fileserver\\apps\\sheetpilot-updates`
- Mapped drive: `file://Z:/sheetpilot-updates`
- Local testing: `file://C:/local-update-server/sheetpilot-updates`

### 2. Create Update Directory Structure

On your network drive, create this structure:

```text
sheetpilot-updates/
├── latest.yml           (auto-generated by electron-builder)
├── Sheetpilot Setup 1.0.0.exe
├── Sheetpilot Setup 1.0.1.exe
└── ...
```

### 3. Build and Publish Updates

#### Initial Release (Version 1.0.0)

```bash
npm run build
```

This creates the installer in `release/Sheetpilot Setup 1.0.0.exe`.

#### Publishing to Network Drive

After building, copy these files to your network drive:

```bash
# From release/ directory, copy to network drive:
- Sheetpilot Setup X.X.X.exe
- latest.yml
```

The `latest.yml` file contains metadata about the current version and is auto-generated by electron-builder.

#### Creating Updates

1. Update the version in `package.json`:

   ```json
   {
     "version": "1.0.1"
   }
   ```

2. Build the new version:

   ```bash
   npm run build
   ```

3. Copy the new files to the network drive:
   - `Sheetpilot Setup 1.0.1.exe`
   - `latest.yml` (overwrite the existing one)

## Update Process Details

### What Happens During Startup

1. App checks `latest.yml` on the network drive
2. Compares version with current installed version
3. If newer version exists, downloads the installer
4. Shows progress in logs (check with developer tools)
5. When download completes, the update is staged

### What Happens on App Quit

1. If an update is staged, electron-updater installs it
2. The new version launches automatically
3. Old version is kept as backup for rollback

### User Experience

- **No interruption**: Updates download in the background
- **No prompts**: Fully automatic (as requested)
- **Seamless**: User closes the app, new version opens
- **Safe**: Atomic updates with automatic rollback on failure

## Testing Updates

### Development Mode

Updates are **disabled** in development mode to prevent conflicts. To test:

1. Build a production version:

   ```bash
   npm run build
   ```

2. Install the built version from `release/`

3. Create a new version (bump version in package.json)

4. Build again and copy to network drive

5. Launch the installed app and check logs

### Checking Logs

The app logs all update activity. To view:

1. Open the app
2. Press `Ctrl+Shift+I` to open DevTools
3. Check Console for `[AutoUpdater]` messages

Example log output:

```text
[AutoUpdater] Checking for updates...
[AutoUpdater] Update available: 1.0.1
[AutoUpdater] Download progress: 25.50%
[AutoUpdater] Download progress: 100.00%
[AutoUpdater] Update downloaded: 1.0.1
[AutoUpdater] Update will be installed on app quit
```

## Versioning Best Practices

Follow [Semantic Versioning](https://semver.org/):

- **MAJOR** (1.0.0 → 2.0.0): Breaking changes
- **MINOR** (1.0.0 → 1.1.0): New features, backward compatible
- **PATCH** (1.0.0 → 1.0.1): Bug fixes

electron-updater only downloads updates if the version number is higher.

## Network Drive Permissions

Ensure all users have:

- **Read** access to the updates folder
- **Execute** access to download installers
- No write access required for users

The build/deployment person needs write access to publish updates.

## Troubleshooting

### Updates Not Detected

1. Verify network drive is accessible: `dir \\SERVER\Share\sheetpilot-updates`
2. Check `latest.yml` exists and is readable
3. Verify version in `package.json` was incremented
4. Check app logs for errors

### Download Fails

1. Ensure installer file exists on network drive
2. Check file permissions
3. Verify file name matches what's in `latest.yml`
4. Check network connectivity

### Update Doesn't Install

1. Ensure user has admin rights (NSIS installers on Windows require elevation)
2. Check if antivirus is blocking the installer
3. Verify the downloaded file isn't corrupted

### Development Testing Issues

Remember: Updates are **disabled** in development mode (`npm run dev`). You must:

- Build with `npm run build`
- Install the built version
- Run the installed .exe (not from `npm run dev`)

## Security Considerations

For internal tools on network drives:

- Code signing is recommended but not required for network deployments
- Users may see Windows SmartScreen warnings without signing
- Network drive should be on a trusted internal network
- Use NTFS permissions to control access

## Advanced Configuration

### Custom Update Check Interval

By default, updates check once at startup. To add periodic checks:

```typescript
// In main.ts, after configureAutoUpdater()
setInterval(() => {
  autoUpdater.checkForUpdates();
}, 3600000); // Check every hour
```

### User Notifications

To notify users about updates, add IPC communication:

```typescript
// In main.ts, update event handler
autoUpdater.on('update-downloaded', (info) => {
  mainWindow?.webContents.send('update-downloaded', info.version);
});
```

### Blocking Updates

To prevent automatic installation:

```typescript
autoUpdater.autoInstallOnAppQuit = false;

// Install on user command
ipcMain.handle('install-update', () => {
  autoUpdater.quitAndInstall();
});
```

## Reference

- [electron-updater Documentation](https://www.electron.build/auto-update)
- [electron-builder Documentation](https://www.electron.build/)
